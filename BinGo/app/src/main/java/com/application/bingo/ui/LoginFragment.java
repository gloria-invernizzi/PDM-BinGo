/// file: app/src/main/java/com/application/bingo/ui/LoginFragment.javapackage com.application.bingo.ui;import android.os.Bundle;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.CheckBox;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.credentials.CredentialManager;import androidx.credentials.CredentialManagerCallback;import androidx.credentials.GetCredentialRequest;import androidx.credentials.GetCredentialResponse;import androidx.credentials.exceptions.GetCredentialCancellationException;import androidx.credentials.exceptions.GetCredentialException;import androidx.credentials.exceptions.GetCredentialProviderConfigurationException;import androidx.credentials.exceptions.NoCredentialException;import androidx.fragment.app.Fragment;import androidx.navigation.Navigation;import com.application.bingo.PrefsManager;import com.application.bingo.R;import com.application.bingo.database.AppDatabase;import com.application.bingo.model.User;import com.google.android.libraries.identity.googleid.GetGoogleIdOption;import com.google.android.libraries.identity.googleid.GoogleIdTokenCredential;// import com.google.android.libraries.identity.googleid.GoogleIdTokenParsingException; // Non piÃ¹ necessario importare l'eccezione specifica se usiamo Exception genericaimport com.google.android.material.textfield.TextInputEditText;import com.google.firebase.auth.AuthCredential;import com.google.firebase.auth.FirebaseAuth;import com.google.firebase.auth.FirebaseUser;import com.google.firebase.auth.GoogleAuthProvider;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;public class LoginFragment extends Fragment {    private TextInputEditText etEmail, etPassword;    private Button btnlogin, btnRegister, btnForgotPassword, btnGoogleSignIn;    private CheckBox cbRemember;    private PrefsManager prefs;    private final ExecutorService bg = Executors.newSingleThreadExecutor();    private FirebaseAuth mAuth;    private CredentialManager credentialManager;    private static final String TAG = LoginFragment.class.getSimpleName();    @Override    public void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        mAuth = FirebaseAuth.getInstance();        credentialManager = CredentialManager.create(requireContext());    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        return inflater.inflate(R.layout.fragment_login, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        prefs = new PrefsManager(requireContext());        etEmail = view.findViewById(R.id.textInputEmail);        etPassword = view.findViewById(R.id.textInputPassword);        btnlogin = view.findViewById(R.id.login_button);        btnRegister = view.findViewById(R.id.register_button);        cbRemember = view.findViewById(R.id.cbRemember);        btnForgotPassword = view.findViewById(R.id.forgot_password_button);        btnGoogleSignIn = view.findViewById(R.id.google_sign_in_button);        cbRemember.setChecked(prefs.isRemember());        cbRemember.setOnCheckedChangeListener((buttonView, isChecked) -> {            prefs.setRemember(isChecked);            if (!isChecked) {                prefs.clearSavedUser();            }        });        setupClickListeners();        checkRememberedUser();    }    private void setupClickListeners() {        btnGoogleSignIn.setOnClickListener(v -> googleSignIn());        btnForgotPassword.setOnClickListener(v ->                Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_recoverPasswordFragment));        btnlogin.setOnClickListener(v -> attemptLogin());        btnRegister.setOnClickListener(v ->                Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_registerFragment));    }    private void googleSignIn() {        GetGoogleIdOption googleIdOption = new GetGoogleIdOption.Builder()                .setFilterByAuthorizedAccounts(false)                .setServerClientId(getString(R.string.default_web_client_id))                .build();        GetCredentialRequest request = new GetCredentialRequest.Builder()                .addCredentialOption(googleIdOption)                .build();        credentialManager.getCredentialAsync(                requireActivity(),                request,                null,                bg,                new CredentialManagerCallback<GetCredentialResponse, GetCredentialException>() {                    @Override                    public void onResult(GetCredentialResponse result) {                        try {                            GoogleIdTokenCredential credential = GoogleIdTokenCredential.createFrom(result.getCredential().getData());                            firebaseAuthWithGoogle(credential.getIdToken());                        } catch (Exception e) { // MODIFICA QUI: Uso Exception generica per evitare errori di compilazione                            Log.e(TAG, "Google Sign-In failed: could not parse token.", e);                            if(isAdded()) {                                requireActivity().runOnUiThread(() -> Toast.makeText(getContext(), "Google Sign-In failed.", Toast.LENGTH_LONG).show());                            }                        }                    }                    @Override                    public void onError(GetCredentialException e) {                        Log.e(TAG, "Google Sign-In failed.", e);                        String message = "An unknown error occurred during Google Sign-In.";                        if (e instanceof GetCredentialCancellationException) {                            Log.i(TAG, "Sign-in cancelled by user.");                            return;                        } else if (e instanceof NoCredentialException) {                            message = "No Google accounts found on this device.";                            Log.w(TAG, message);                        } else if (e instanceof GetCredentialProviderConfigurationException) {                            message = "Google Sign-In is not configured correctly. Check your app's configuration.";                            Log.e(TAG, "Google Sign-In provider configuration error.", e);                        }                        final String finalMessage = message;                        if(isAdded()) {                            requireActivity().runOnUiThread(() -> Toast.makeText(getContext(), finalMessage, Toast.LENGTH_LONG).show());                        }                    }                }        );    }    private void checkRememberedUser() {        if (!prefs.isRemember()) return;        final String savedEmail = prefs.getSavedEmail();        final String savedPass = prefs.getSavedPassword();        if (!savedEmail.isEmpty() && !savedPass.isEmpty()) {            bg.execute(() -> {                User u = AppDatabase.getInstance(requireContext())                        .userDao()                        .findByEmailAndPassword(savedEmail, savedPass);                if (u != null) {                    requireActivity().runOnUiThread(() -> {                        etEmail.setText(savedEmail);                        etPassword.setText(savedPass);                        cbRemember.setChecked(true);                    });                }            });        }    }    private void attemptLogin() {        final String email = getText(etEmail);        final String pass = getText(etPassword);        if (email.isEmpty() || pass.isEmpty()) {            Toast.makeText(requireContext(), "Campi mancanti", Toast.LENGTH_SHORT).show();            return;        }        bg.execute(() -> {            User localUser = AppDatabase.getInstance(requireContext()).userDao().findByEmailAndPassword(email, pass);            if (localUser != null) {                requireActivity().runOnUiThread(() -> {                    Log.d(TAG, "Login effettuato tramite cache locale (Room).");                    loginSuccess(localUser.getName(), email, pass);                });            } else {                requireActivity().runOnUiThread(() -> {                    Log.d(TAG, "Utente non trovato in locale. Tento il login con Firebase.");                    firebaseSignIn(email, pass);                });            }        });    }    private void firebaseAuthWithGoogle(String idToken) {        AuthCredential credential = GoogleAuthProvider.getCredential(idToken, null);        mAuth.signInWithCredential(credential)                .addOnCompleteListener(requireActivity(), task -> {                    if (task.isSuccessful()) {                        Log.d(TAG, "Firebase Sign-In with Google successful.");                        FirebaseUser firebaseUser = mAuth.getCurrentUser();                        String name = (firebaseUser != null && firebaseUser.getDisplayName() != null) ? firebaseUser.getDisplayName() : "";                        String email = (firebaseUser != null) ? firebaseUser.getEmail() : "";                        String password = "";                        bg.execute(() -> {                            User local = AppDatabase.getInstance(requireContext()).userDao().findByEmail(email);                            if (local == null) {                                User newUser = new User(name, "", email, password);                                AppDatabase.getInstance(requireContext()).userDao().insert(newUser);                                Log.d(TAG, "New Google user saved to Room DB.");                            } else {                                Log.d(TAG, "Google user already exists in Room DB.");                            }                        });                        loginSuccess(name, email, password);                    } else {                        Log.w(TAG, "Firebase Sign-In with Google failed", task.getException());                        Toast.makeText(requireContext(), "Firebase authentication failed.", Toast.LENGTH_SHORT).show();                    }                });    }    private void firebaseSignIn(final String email, final String pass) {        mAuth.signInWithEmailAndPassword(email, pass).addOnCompleteListener(requireActivity(), task -> {            if (task.isSuccessful()) {                FirebaseUser firebaseUser = mAuth.getCurrentUser();                String name = (firebaseUser != null && firebaseUser.getDisplayName() != null) ? firebaseUser.getDisplayName() : "";                bg.execute(() -> {                    User local = AppDatabase.getInstance(requireContext()).userDao().findByEmail(email);                    if (local == null) {                        User newUser = new User(name, "", email, pass);                        AppDatabase.getInstance(requireContext()).userDao().insert(newUser);                        Log.d(TAG, "New user synced to Room DB.");                    }                });                loginSuccess(name, email, pass);            } else {                String msg = task.getException() != null ? task.getException().getMessage() : "Invalid credentials";                Toast.makeText(requireContext(), "Login failed: " + msg, Toast.LENGTH_SHORT).show();            }        });    }    private void loginSuccess(String name, String email, String password) {        if (cbRemember != null && cbRemember.isChecked()) {            prefs.saveUser(name, "", email, password);        }        Toast.makeText(requireContext(), "Login effettuato", Toast.LENGTH_SHORT).show();        if (getView() != null) {            // Navigazione verso il grafico della Home            Navigation.findNavController(requireView()).navigate(R.id.action_loginFragment_to_nav_graph_home);        }    }    private String getText(TextInputEditText et) {        return et == null || et.getText() == null ? "" : et.getText().toString().trim();    }}