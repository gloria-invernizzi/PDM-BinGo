package com.application.bingo.ui;import android.os.Bundle;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.CheckBox;import android.widget.ProgressBar;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.credentials.CredentialManager;import androidx.credentials.CredentialManagerCallback;import androidx.credentials.GetCredentialRequest;import androidx.credentials.GetCredentialResponse;import androidx.credentials.exceptions.GetCredentialCancellationException;import androidx.credentials.exceptions.GetCredentialException;import androidx.fragment.app.Fragment;import androidx.lifecycle.ViewModelProvider;import androidx.core.content.ContextCompat;import androidx.navigation.Navigation;import com.application.bingo.PrefsManager;import com.application.bingo.R;import com.application.bingo.ui.viewmodel.LoginViewModel;import com.application.bingo.util.CredentialUtils;import com.google.android.libraries.identity.googleid.GetGoogleIdOption;import com.google.android.libraries.identity.googleid.GoogleIdTokenCredential;import com.google.android.material.textfield.TextInputEditText;import com.google.firebase.auth.AuthCredential;import com.google.firebase.auth.GoogleAuthProvider;/** * LoginFragment: * Manages the user login UI, supporting email/password and Google Sign-In. */public class LoginFragment extends Fragment {    private TextInputEditText etEmail, etPassword;    private Button btnlogin, btnForgotPassword, btnGoogleSignIn;    private CheckBox cbRemember;    private ProgressBar progressBar;    private PrefsManager prefs;    private LoginViewModel viewModel;    private CredentialManager credentialManager;    private static final String TAG = LoginFragment.class.getSimpleName();    @Override    public void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        credentialManager = CredentialManager.create(requireContext());        viewModel = new ViewModelProvider(this).get(LoginViewModel.class);    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {        return inflater.inflate(R.layout.fragment_login, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        prefs = new PrefsManager(requireContext());        etEmail = view.findViewById(R.id.textInputEmail);        etPassword = view.findViewById(R.id.textInputPassword);        btnlogin = view.findViewById(R.id.login_button);        cbRemember = view.findViewById(R.id.cbRemember);        btnForgotPassword = view.findViewById(R.id.forgot_password_button);        btnGoogleSignIn = view.findViewById(R.id.google_sign_in_button);        progressBar = view.findViewById(R.id.login_progress);        // Load saved credentials if 'Remember Me' was checked previously        if (prefs.isRemember()) {            cbRemember.setChecked(true);            etEmail.setText(prefs.getSavedEmail());            etPassword.setText(prefs.getSavedPassword());        }        setupObservers();        setupClickListeners();    }    /**     * Observes the login state from the ViewModel.     */    private void setupObservers() {        viewModel.loginState.observe(getViewLifecycleOwner(), state -> {            if (state instanceof LoginViewModel.LoginState.Loading) {                setLoading(true);            } else if (state instanceof LoginViewModel.LoginState.Success) {                setLoading(false);                onLoginSuccess((LoginViewModel.LoginState.Success) state);            } else if (state instanceof LoginViewModel.LoginState.Error) {                setLoading(false);                Toast.makeText(requireContext(), ((LoginViewModel.LoginState.Error) state).message, Toast.LENGTH_SHORT).show();            }        });    }    /**     * Updates UI visibility during loading state.     */    private void setLoading(boolean isLoading) {        if (progressBar != null) progressBar.setVisibility(isLoading ? View.VISIBLE : View.GONE);        btnlogin.setEnabled(!isLoading);    }    /**     * Handles successful login by saving user data and navigating to the home screen.     */    private void onLoginSuccess(LoginViewModel.LoginState.Success success) {        // Handle 'Remember Me' preference        if (cbRemember.isChecked()) {            prefs.setRemember(true);            prefs.saveUser(success.name, success.surname, success.address, success.email, success.password);        } else {            prefs.setRemember(false);            prefs.clearSavedUser();            prefs.saveSessionEmail(success.email);        }                Toast.makeText(requireContext(), R.string.login_successful, Toast.LENGTH_SHORT).show();        Navigation.findNavController(requireView()).navigate(R.id.action_loginFragment_to_nav_graph_home);    }    /**     * Sets up click listeners for login and navigation buttons.     */    private void setupClickListeners() {        btnlogin.setOnClickListener(v -> {            String email = etEmail.getText().toString().trim();            String pass = etPassword.getText().toString().trim();            if (email.isEmpty() || pass.isEmpty()) {                Toast.makeText(requireContext(), R.string.error_missing_fields, Toast.LENGTH_SHORT).show();            } else {                viewModel.login(email, pass);            }        });        btnGoogleSignIn.setOnClickListener(v -> startGoogleSignIn());        btnForgotPassword.setOnClickListener(v -> Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_recoverPasswordFragment));    }    /**     * Starts the Google Sign-In flow using Credential Manager.     */    private void startGoogleSignIn() {        GetGoogleIdOption googleIdOption = new GetGoogleIdOption.Builder()                .setFilterByAuthorizedAccounts(false)                .setServerClientId(getString(R.string.default_web_client_id))                .setAutoSelectEnabled(false)                .build();        GetCredentialRequest request = new GetCredentialRequest.Builder()                .addCredentialOption(googleIdOption)                .build();        credentialManager.getCredentialAsync(requireActivity(), request, null, ContextCompat.getMainExecutor(requireContext()),            new CredentialManagerCallback<GetCredentialResponse, GetCredentialException>() {                @Override                public void onResult(GetCredentialResponse result) {                    try {                        GoogleIdTokenCredential credential = GoogleIdTokenCredential.createFrom(result.getCredential().getData());                        AuthCredential authCredential = GoogleAuthProvider.getCredential(credential.getIdToken(), null);                        viewModel.loginWithGoogle(authCredential);                    } catch (Exception e) {                        Log.e(TAG, "Error parsing Google credential", e);                    }                }                @Override                public void onError(GetCredentialException e) {                    if (e instanceof androidx.credentials.exceptions.NoCredentialException) {                        CredentialUtils.promptToAddGoogleAccount(requireContext());                    } else if (!(e instanceof GetCredentialCancellationException)) {                        Toast.makeText(requireContext(), R.string.error_google_sign_in, Toast.LENGTH_SHORT).show();                    }                }            });    }}