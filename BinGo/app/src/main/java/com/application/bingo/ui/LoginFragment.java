package com.application.bingo.ui;import android.os.Bundle;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.CheckBox;import android.widget.ProgressBar;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.credentials.CredentialManager;import androidx.credentials.CredentialManagerCallback;import androidx.credentials.GetCredentialRequest;import androidx.credentials.GetCredentialResponse;import androidx.credentials.exceptions.GetCredentialCancellationException;import androidx.credentials.exceptions.GetCredentialException;import androidx.fragment.app.Fragment;import androidx.lifecycle.ViewModelProvider;import androidx.core.content.ContextCompat;import androidx.navigation.Navigation;import com.application.bingo.PrefsManager;import com.application.bingo.R;import com.application.bingo.ui.viewmodel.LoginViewModel;import com.application.bingo.util.CredentialUtils;import com.google.android.libraries.identity.googleid.GetGoogleIdOption;import com.google.android.libraries.identity.googleid.GoogleIdTokenCredential;import com.google.android.material.textfield.TextInputEditText;import com.google.firebase.auth.AuthCredential;import com.google.firebase.auth.GoogleAuthProvider;public class LoginFragment extends Fragment {    private TextInputEditText etEmail, etPassword;    private Button btnlogin, btnForgotPassword, btnGoogleSignIn;    private CheckBox cbRemember;    private ProgressBar progressBar;    private PrefsManager prefs;    private LoginViewModel viewModel;    private CredentialManager credentialManager;    private static final String TAG = LoginFragment.class.getSimpleName();    @Override    public void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        credentialManager = CredentialManager.create(requireContext());        viewModel = new ViewModelProvider(this).get(LoginViewModel.class);    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {        return inflater.inflate(R.layout.fragment_login, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        prefs = new PrefsManager(requireContext());        etEmail = view.findViewById(R.id.textInputEmail);        etPassword = view.findViewById(R.id.textInputPassword);        btnlogin = view.findViewById(R.id.login_button);        cbRemember = view.findViewById(R.id.cbRemember);        btnForgotPassword = view.findViewById(R.id.forgot_password_button);        btnGoogleSignIn = view.findViewById(R.id.google_sign_in_button);        progressBar = view.findViewById(R.id.login_progress);        // 1. Carichiamo lo stato salvato PRIMA di impostare il listener        boolean rememberMe = prefs.isRemember();        cbRemember.setChecked(rememberMe);                if (rememberMe) {            etEmail.setText(prefs.getSavedEmail());            etPassword.setText(prefs.getSavedPassword());        }        // 2. Impostiamo il listener per gestire i cambiamenti futuri        cbRemember.setOnCheckedChangeListener((buttonView, isChecked) -> {            prefs.setRemember(isChecked);            if (!isChecked) {                prefs.clearSavedUser();            }        });        setupObservers();        setupClickListeners();    }    private void setupObservers() {        viewModel.loginState.observe(getViewLifecycleOwner(), state -> {            if (state instanceof LoginViewModel.LoginState.Loading) {                setLoading(true);            } else if (state instanceof LoginViewModel.LoginState.Success) {                setLoading(false);                LoginViewModel.LoginState.Success success = (LoginViewModel.LoginState.Success) state;                onLoginSuccess(success);            } else if (state instanceof LoginViewModel.LoginState.Error) {                setLoading(false);                String error = ((LoginViewModel.LoginState.Error) state).message;                Toast.makeText(requireContext(), error, Toast.LENGTH_SHORT).show();            }        });    }    private void setLoading(boolean isLoading) {        if (progressBar != null) progressBar.setVisibility(isLoading ? View.VISIBLE : View.GONE);        btnlogin.setEnabled(!isLoading);        btnGoogleSignIn.setEnabled(!isLoading);    }    private void onLoginSuccess(LoginViewModel.LoginState.Success success) {        // Se la checkbox Ã¨ spuntata al momento del login, salviamo/aggiorniamo i dati        if (cbRemember.isChecked()) {            prefs.saveUser(success.name, success.surname, success.address, success.email, success.password);        } else {            // L'utente non vuole essere ricordato: pulisco ma salvo l'email per la sessione attuale            prefs.clearSavedUser();            prefs.saveSessionEmail(success.email);        }                Toast.makeText(requireContext(), R.string.login_successful, Toast.LENGTH_SHORT).show();        Navigation.findNavController(requireView()).navigate(R.id.action_loginFragment_to_nav_graph_home);    }    private void setupClickListeners() {        btnlogin.setOnClickListener(v -> {            String email = etEmail.getText().toString().trim();            String pass = etPassword.getText().toString().trim();            if (email.isEmpty() || pass.isEmpty()) {                Toast.makeText(requireContext(), R.string.error_missing_fields, Toast.LENGTH_SHORT).show();            } else {                viewModel.login(email, pass);            }        });        btnGoogleSignIn.setOnClickListener(v -> startGoogleSignIn());        btnForgotPassword.setOnClickListener(v -> Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_recoverPasswordFragment));    }    private void startGoogleSignIn() {        GetGoogleIdOption googleIdOption = new GetGoogleIdOption.Builder()                .setFilterByAuthorizedAccounts(false)                .setServerClientId(getString(R.string.default_web_client_id))                .setAutoSelectEnabled(false)                .build();        GetCredentialRequest request = new GetCredentialRequest.Builder()                .addCredentialOption(googleIdOption)                .build();        credentialManager.getCredentialAsync(requireActivity(), request, null, ContextCompat.getMainExecutor(requireContext()),            new CredentialManagerCallback<GetCredentialResponse, GetCredentialException>() {                @Override                public void onResult(GetCredentialResponse result) {                    try {                        GoogleIdTokenCredential credential = GoogleIdTokenCredential.createFrom(result.getCredential().getData());                        AuthCredential authCredential = GoogleAuthProvider.getCredential(credential.getIdToken(), null);                        viewModel.loginWithGoogle(authCredential);                    } catch (Exception e) {                        Log.e(TAG, "Error parsing Google credential", e);                    }                }                @Override                public void onError(GetCredentialException e) {                    if (e instanceof androidx.credentials.exceptions.NoCredentialException) {                        Log.e(TAG, "Nessun account disponibile.");                        // Chiediamo all'utente se vuole aggiungere un account                        CredentialUtils.promptToAddGoogleAccount(requireContext());                    } else if (!(e instanceof GetCredentialCancellationException)) {                        Log.e(TAG, "Google Sign-In Error", e);                        Toast.makeText(requireContext(), R.string.error_google_sign_in, Toast.LENGTH_SHORT).show();                    }                }            });    }}