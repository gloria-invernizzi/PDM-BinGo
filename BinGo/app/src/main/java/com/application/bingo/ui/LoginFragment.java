// file: app/src/main/java/com/application/bingo/ui/LoginFragment.java//DA CONTROLLARE: L'AUTO-FILL IN DOVREBBE FUNZIONARE SE L'UTENTE E' PRESENTE ANCHE IN ROOMpackage com.application.bingo.ui;import android.app.Activity;import android.os.Bundle;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.CheckBox;import android.widget.Toast;import androidx.activity.result.ActivityResultLauncher;import androidx.activity.result.IntentSenderRequest;import androidx.activity.result.contract.ActivityResultContracts;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.fragment.app.Fragment;import androidx.navigation.Navigation;import com.application.bingo.util.database.AppDatabase;import com.application.bingo.PrefsManager;import com.application.bingo.R;import com.application.bingo.util.database.User;import com.google.android.gms.auth.api.identity.BeginSignInRequest;import com.google.android.gms.auth.api.identity.Identity;import com.google.android.gms.auth.api.identity.SignInClient;import com.google.android.gms.auth.api.identity.SignInCredential;import com.google.android.gms.common.api.ApiException;import com.google.android.material.textfield.TextInputEditText;import com.google.firebase.auth.AuthCredential;import com.google.firebase.auth.FirebaseAuth;import com.google.firebase.auth.FirebaseUser;import com.google.firebase.auth.GoogleAuthProvider;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;public class LoginFragment extends Fragment {    private TextInputEditText etEmail, etPassword;    private Button btnlogin, btnRegister, btnForgotPassword, btnGoogleSignIn;    private CheckBox cbRemember;    private PrefsManager prefs;    private final ExecutorService bg = Executors.newSingleThreadExecutor();    private FirebaseAuth mAuth;    // Google Sign-In    private SignInClient oneTapClient;    private BeginSignInRequest signInRequest;    private ActivityResultLauncher<IntentSenderRequest> oneTapLauncher;    private static final String TAG = LoginFragment.class.getSimpleName();    @Override    public void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        mAuth = FirebaseAuth.getInstance();        oneTapClient = Identity.getSignInClient(requireActivity());        oneTapLauncher = registerForActivityResult(                new ActivityResultContracts.StartIntentSenderForResult(),                result -> {                    // Controlla resultCode e che l'intent non sia nullo                    if (result.getResultCode() != Activity.RESULT_OK || result.getData() == null) {                        requireActivity().runOnUiThread(() -> {                            if (isAdded()) {                                Toast.makeText(requireContext(), "Operazione annullata o dati mancanti.", Toast.LENGTH_SHORT).show();                            } else {                                Log.w(TAG, "Fragment non attaccato: skip Toast su result non OK");                            }                            clearPasswordField();                        });                        return;                    }                    try {                        SignInCredential credential = oneTapClient.getSignInCredentialFromIntent(result.getData());                        String idToken = credential.getGoogleIdToken();                        if (idToken != null && !idToken.isEmpty()) {                            Log.d(TAG, "Ottenuto Google ID Token, avvio autenticazione con Firebase...");                            firebaseAuthWithGoogle(idToken);                        } else {                            requireActivity().runOnUiThread(() -> {                                if (isAdded()) {                                    Toast.makeText(requireContext(), "Nessun ID token ricevuto.", Toast.LENGTH_SHORT).show();                                }                                clearPasswordField();                            });                        }                    } catch (ApiException e) {                        Log.e(TAG, "Accesso Google fallito dopo la selezione dell'account", e);                        requireActivity().runOnUiThread(() -> {                            if (isAdded()) {                                Toast.makeText(requireContext(), "Accesso con Google fallito.", Toast.LENGTH_SHORT).show();                            } else {                                Log.w(TAG, "Fragment non attaccato: skip Toast su ApiException");                            }                            clearPasswordField();                        });                    } catch (Exception e) {                        Log.e(TAG, "Errore imprevisto nel processamento del risultato Google", e);                        requireActivity().runOnUiThread(() -> {                            if (isAdded()) {                                Toast.makeText(requireContext(), "Errore durante l'accesso con Google.", Toast.LENGTH_SHORT).show();                            }                            clearPasswordField();                        });                    }                });    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        return inflater.inflate(R.layout.fragment_login, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        prefs = new PrefsManager(requireContext());        etEmail = view.findViewById(R.id.textInputEmail);        etPassword = view.findViewById(R.id.textInputPassword);        btnlogin = view.findViewById(R.id.login_button);        btnRegister = view.findViewById(R.id.register_button);        cbRemember = view.findViewById(R.id.cbRemember);        btnForgotPassword = view.findViewById(R.id.forgot_password_button);        btnGoogleSignIn = view.findViewById(R.id.google_sign_in_button);        cbRemember.setChecked(prefs.isRemember());        cbRemember.setOnCheckedChangeListener((buttonView, isChecked) -> {            prefs.setRemember(isChecked);        });        signInRequest = BeginSignInRequest.builder()                .setGoogleIdTokenRequestOptions(BeginSignInRequest.GoogleIdTokenRequestOptions.builder()                        .setSupported(true)                        .setServerClientId(getString(R.string.default_web_client_id))                        .setFilterByAuthorizedAccounts(false)                        .build())                .setAutoSelectEnabled(false)                .build();        setupClickListeners();        checkRememberedUser();    }    private void setupClickListeners() {        btnGoogleSignIn.setOnClickListener(v -> {            Log.d(TAG, "Pulsante Google Sign-In cliccato. Avvio beginSignIn...");            oneTapClient.beginSignIn(signInRequest)                    .addOnSuccessListener(requireActivity(), result -> {                        Log.d(TAG, "beginSignIn ha avuto successo. Avvio il launcher di Google.");                        IntentSenderRequest intentSenderRequest =                                new IntentSenderRequest.Builder(result.getPendingIntent().getIntentSender()).build();                        oneTapLauncher.launch(intentSenderRequest);                    })                    .addOnFailureListener(requireActivity(), e -> {                        Log.e(TAG, "beginSignIn fallito!", e);                        if (isAdded()) {                            Toast.makeText(requireContext(), "Impossibile avviare l'accesso con Google.", Toast.LENGTH_LONG).show();                        } else {                            Log.w(TAG, "Fragment non attaccato: skip Toast su beginSignIn failure");                        }                        clearPasswordField();                    });        });        btnForgotPassword.setOnClickListener(v ->                Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_recoverPasswordFragment));        btnlogin.setOnClickListener(v -> attemptLogin());        btnRegister.setOnClickListener(v ->                Navigation.findNavController(v).navigate(R.id.action_loginFragment_to_registerFragment));    }    private void checkRememberedUser() {        if (!prefs.isRemember()) return;        final String savedEmail = prefs.getSavedEmail();        final String savedPass = prefs.getSavedPassword();        if (!savedEmail.isEmpty() && !savedPass.isEmpty()) {            bg.execute(() -> {                User u = AppDatabase.getInstance(requireContext())                        .userDao()                        .findByEmailAndPassword(savedEmail, savedPass);                if (u != null) {                    requireActivity().runOnUiThread(() -> {                        etEmail.setText(savedEmail);                        etPassword.setText(savedPass);                        cbRemember.setChecked(true);                    });                } else {                    prefs.clearSavedUser();                }            });        }    }    private void attemptLogin() {        final String email = getText(etEmail);        final String pass = getText(etPassword);        if (email.isEmpty() || pass.isEmpty()) {            Toast.makeText(requireContext(), "Campi mancanti", Toast.LENGTH_SHORT).show();            return;        }        bg.execute(() -> {            User localUser = AppDatabase.getInstance(requireContext()).userDao().findByEmailAndPassword(email, pass);            if (localUser != null) {                requireActivity().runOnUiThread(() -> {                    Log.d(TAG, "Login effettuato tramite cache locale (Room).");                    clearInputFields();                    loginSuccess(localUser.getName(), email, pass);                });            } else {                requireActivity().runOnUiThread(() -> {                    Log.d(TAG, "Utente non trovato in locale. Tento il login con Firebase.");                    firebaseSignIn(email, pass);                });            }        });    }    private void firebaseAuthWithGoogle(String idToken) {        AuthCredential credential = GoogleAuthProvider.getCredential(idToken, null);        mAuth.signInWithCredential(credential)                .addOnCompleteListener(requireActivity(), task -> {                    if (task.isSuccessful()) {                        Log.d(TAG, "Firebase Sign-In with Google successful.");                        FirebaseUser firebaseUser = mAuth.getCurrentUser();                        String name = firebaseUser != null && firebaseUser.getDisplayName() != null ? firebaseUser.getDisplayName() : "";                        String email = firebaseUser != null ? firebaseUser.getEmail() : "";                        String password = "";                        bg.execute(() -> {                            User local = AppDatabase.getInstance(requireContext()).userDao().findByEmail(email);                            if (local == null) {                                User newUser = new User(name, "", email, password);                                AppDatabase.getInstance(requireContext()).userDao().insert(newUser);                                Log.d(TAG, "Nuovo utente Google salvato in Room DB.");                            } else {                                Log.d(TAG, "Utente Google già presente in Room DB. Login con ID esistente.");                            }                            if (prefs.isRemember()) {                                prefs.saveUser(name, "", email, password);                                prefs.setRemember(true);                                Log.d(TAG, "Prefs salvate per Google user: savedEmail=" + prefs.getSavedEmail());                            }                        });                        clearInputFields();                        loginSuccess(name, email, password);                    } else {                        Log.w(TAG, "Firebase Sign-In with Google failed", task.getException());                        if (isAdded()) {                            Toast.makeText(requireContext(), "Autenticazione con Firebase fallita.", Toast.LENGTH_SHORT).show();                        }                        clearPasswordField();                    }                });    }    private void firebaseSignIn(final String email, final String pass) {        mAuth.signInWithEmailAndPassword(email, pass).addOnCompleteListener(requireActivity(), task -> {            if (task.isSuccessful()) {                FirebaseUser firebaseUser = mAuth.getCurrentUser();                String name = (firebaseUser != null && firebaseUser.getDisplayName() != null) ? firebaseUser.getDisplayName() : "";                bg.execute(() -> {                    User local = AppDatabase.getInstance(requireContext()).userDao().findByEmail(email);                    if (local == null) {                        User newUser = new User(name, "", email, pass);                        AppDatabase.getInstance(requireContext()).userDao().insert(newUser);                        Log.d(TAG, "Nuovo utente sincronizzato in Room DB.");                    } else {                        Log.d(TAG, "Utente già presente in locale. Salto inserimento.");                    }                });                clearInputFields();                loginSuccess(name, email, pass);            } else {                String msg = task.getException() != null ? task.getException().getMessage() : "Credenziali non valide";                Log.w(TAG, "Firebase sign-in failed: " + msg);                bg.execute(() -> {                    boolean emailRegistered = AppDatabase.getInstance(requireContext()).userDao().findByEmail(email) != null;                    requireActivity().runOnUiThread(() -> {                        if (emailRegistered) {                            Toast.makeText(requireContext(), "Password errata", Toast.LENGTH_SHORT).show();                            clearPasswordField();                        } else {                            Toast.makeText(requireContext(), "Utente non registrato", Toast.LENGTH_SHORT).show();                        }                    });                });            }        });    }    private void loginSuccess(String name, String email, String password) {        if (cbRemember != null && cbRemember.isChecked() && !email.isEmpty()) {            prefs.saveUser(name != null ? name : "", "", email, password != null ? password : "");            prefs.setRemember(true);            Log.d(TAG, "loginSuccess: prefs salvate. savedEmail=" + prefs.getSavedEmail() + " isRemember=" + prefs.isRemember());        } else if (cbRemember != null && !cbRemember.isChecked()) {            prefs.clearSavedUser();            prefs.setRemember(false);            Log.d(TAG, "loginSuccess: prefs cancellate. isRemember=" + prefs.isRemember());        }        if (isAdded()) {            Toast.makeText(requireContext(), "Login effettuato", Toast.LENGTH_SHORT).show();            if (getView() != null) {                Navigation.findNavController(requireView()).navigate(R.id.action_loginFragment_to_nav_graph_home);            }        }    }    private void clearInputFields() {        if (getActivity() == null) return;        requireActivity().runOnUiThread(() -> {            if (etEmail != null) etEmail.setText("");            if (etPassword != null) etPassword.setText("");        });    }    private void clearPasswordField() {        if (getActivity() == null) return;        requireActivity().runOnUiThread(() -> {            if (etPassword != null) etPassword.setText("");        });    }    private String getText(TextInputEditText et){        return et == null || et.getText() == null ? "" : et.getText().toString().trim();    }}